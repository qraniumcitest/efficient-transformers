name: Mirror Fork PRs to GHES

on:
  pull_request:
    # PR created, draft→ready transition, commits, reopen, close
    types: [opened, ready_for_review, synchronize, reopened, closed]
    branches: ["main"]

# Per-PR concurrency avoids cross-PR contention
concurrency:
  group: fork-pr-mirror-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  mirror_or_close:
    runs-on: [self-hosted, linux, x64]
    env:
      GHES_BASE_URL: https://github.qualcomm.com
      GHES_OWNER: qranium
      GHES_REPO: efficient-transformers
      FORK_OWNER: "qraniumcitest"
      FORK_REPO: "efficient-transformers"
      # Preview headers required for draft/ready endpoints on GHES
      GH_ACCEPT: "application/vnd.github+json, application/vnd.github.shadow-cat-preview+json"

    steps:
      - name: Exit if running in internal repo
        if: github.repository == 'qranium/efficient-transformers'
        run: |
          echo "This workflow should not run in the internal repo. Exiting."
          exit 0

      - name: Debug event
        run: |
          echo "Event name  : ${{ github.event_name }}"
          echo "Action      : ${{ github.event.action }}"
          echo "PR number   : ${{ github.event.pull_request.number }}"
          echo "PR draft    : ${{ github.event.pull_request.draft }}"
          echo "Head ref    : ${{ github.event.pull_request.head.ref }}"
          echo "Head sha    : ${{ github.event.pull_request.head.sha }}"

      - name: Preflight - verify GHES env and connectivity
        run: |
          set -e
          echo "GHES_BASE_URL=${GHES_BASE_URL}"
          echo "GHES_OWNER    =${GHES_OWNER}"
          echo "GHES_REPO     =${GHES_REPO}"
          nslookup github.qualcomm.com || (echo "DNS lookup failed. Connect VPN then re-run"; exit 1)
          curl -I --max-time 10 "https://github.qualcomm.com" || (echo "Cannot reach GHES over HTTPS. Connect VPN then re-run"; exit 1)

      - name: Checkout PR head
        if: github.event.action != 'closed'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Configure git
        if: github.event.action != 'closed'
        run: |
          git config user.email "pr-mirror@local"
          git config user.name  "pr-mirror"

      - name: Add GHES remote
        if: github.event.action != 'closed'
        env:
          GHES_USER: ${{ secrets.GHES_USER }}
          GHES_PAT:  ${{ secrets.GHES_PAT  }}
        run: |
          set -e
          git remote add ghes "${GHES_BASE_URL}/${GHES_OWNER}/${GHES_REPO}.git" || true
          git remote set-url ghes "https://${GHES_USER}:${GHES_PAT}@github.qualcomm.com/${GHES_OWNER}/${GHES_REPO}.git"
          git ls-remote ghes --heads

      - name: Push PR branch to GHES
        if: github.event.action != 'closed'
        id: push_branch
        run: |
          set -euo pipefail
          PR_NUM="${{ github.event.pull_request.number }}"
          BRANCH="fork-pr-${PR_NUM}"
          git push ghes "HEAD:refs/heads/${BRANCH}" --force
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"

      - name: Create/Update GHES PR (metadata + marker + freshness)
        if: github.event.action != 'closed'
        id: ensure_pr
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        run: |
          set -euo pipefail
          PR_NUM="${{ github.event.pull_request.number }}"
          BRANCH="${{ steps.push_branch.outputs.branch }}"
          TITLE="${{ github.event.pull_request.title }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          BODY_RAW="${{ github.event.pull_request.body }}"
          URL="${{ github.event.pull_request.html_url }}"
          DRAFT_FLAG="${{ github.event.pull_request.draft }}"
          BODY_ESCAPED="$(echo "$BODY_RAW" | tr '\n' ' ' | tr '\r' ' ')"

          META=$(printf '%s\n%s\n%s\n%s\n%s\n%s\n%s\n' \
                '[Mirror Metadata]' \
                "Original-PR-Repo: ${{ env.FORK_OWNER }}/${{ env.FORK_REPO }}" \
                "Original-PR-Number: ${PR_NUM}" \
                "Original-PR-URL: ${URL}" \
                "Original-Head-SHA: ${HEAD_SHA}" \
                "Original-Head-Branch: ${HEAD_REF}" \
                "Upstream-Draft:${DRAFT_FLAG}")

          FRESHNESS="Mirror-Updated-At: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"  # guarantees `edited`

          PR_BODY=$(printf '%s\n\n%s\n%s\n\n%s\n' \
            "$URL" \
            "$META" \
            "$FRESHNESS" \
            "$BODY_ESCAPED")

          API="${{ env.GHES_BASE_URL }}/api/v3/repos/${{ env.GHES_OWNER }}/${{ env.GHES_REPO }}/pulls"
          EXISTING=$(curl -s \
                      -H "Authorization: token ${GHES_PAT}" \
                      -H "Accept: ${GH_ACCEPT}" \
                      "${API}?state=open&head=${GHES_OWNER}:${BRANCH}" | jq -r '.[0].number // empty')

          if [ "$DRAFT_FLAG" = "true" ]; then DRAFT_JSON=true; else DRAFT_JSON=false; fi

          if [ -n "$EXISTING" ]; then
            echo "Updating GHES PR #${EXISTING}"
            curl -s -X PATCH \
              -H "Authorization: token ${GHES_PAT}" \
              -H "Accept: ${GH_ACCEPT}" \
              "${API}/${EXISTING}" \
              -d "$(jq -n --arg t "[Fork PR #${PR_NUM}] ${TITLE}" --arg b "$PR_BODY" '{title:$t, body:$b}')" > /dev/null
            echo "existing_pr=${EXISTING}" >> "$GITHUB_OUTPUT"
          else
            echo "Creating GHES PR (draft=${DRAFT_JSON})"
            RESP=$(curl -s -X POST \
              -H "Authorization: token ${GHES_PAT}" \
              -H "Accept: ${GH_ACCEPT}" \
              "${API}" \
              -d "$(jq -n \
                    --arg t "[Fork PR #${PR_NUM}] ${TITLE}" \
                    --arg h "${BRANCH}" \
                    --arg b "$PR_BODY" \
                    --arg base "main" \
                    --argjson draft "$DRAFT_JSON" \
                    '{title:$t, head:$h, base:$base, body:$b, draft:$draft}')" )
            CREATED_NUM=$(echo "$RESP" | jq -r '.number // empty')
            echo "existing_pr=${CREATED_NUM}" >> "$GITHUB_OUTPUT"
          fi

      - name: Align GHES PR state to upstream (best-effort)
        if: github.event.action != 'closed'
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        run: |
          set -euo pipefail
          API_BASE="${{ env.GHES_BASE_URL }}/api/v3/repos/${{ env.GHES_OWNER }}/${{ env.GHES_REPO }}"
          GH_ACCEPT="${GH_ACCEPT}"
          DRAFT_FLAG="${{ github.event.pull_request.draft }}"
          PR_ID="${{ steps.ensure_pr.outputs.existing_pr }}"

          # Resolve PR_ID with small retry (indexing lag)
          ATTEMPTS=0
          while [ -z "${PR_ID}" ] && [ $ATTEMPTS -lt 3 ]; do
            sleep 2
            PR_NUM="${{ github.event.pull_request.number }}"
            BRANCH="fork-pr-${PR_NUM}"
            PR_ID="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                      "${API_BASE}/pulls?state=open&head=${{ env.GHES_OWNER }}:${BRANCH}" \
                     | jq -r '.[0].number // empty')"
            ATTEMPTS=$((ATTEMPTS+1))
          done

          if [ -z "${PR_ID}" ]; then
            echo "No GHES PR number resolved; skipping state alignment."
            exit 0
          fi

          API_PR="${API_BASE}/pulls/${PR_ID}"

          if [ "$DRAFT_FLAG" = "true" ]; then
            echo "Upstream=DRAFT → nudge GHES (ready→draft)"
            curl -sS -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                 "${API_PR}/ready_for_review" -o /dev/null || true
            sleep 1
            curl -sS -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                 "${API_PR}/convert_to_draft" -o /dev/null || true
          else
            echo "Upstream=READY → nudge GHES (draft→ready)"
            curl -sS -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                 "${API_PR}/convert_to_draft" -o /dev/null || true
            sleep 1
            curl -sS -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                 "${API_PR}/ready_for_review" -o /dev/null || true
          fi

      - name: Ensure labels exist (mirror:ready, mirror:draft)
        if: github.event.action != 'closed'
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        run: |
          set -euo pipefail
          API="${{ env.GHES_BASE_URL }}/api/v3/repos/${{ env.GHES_OWNER }}/${{ env.GHES_REPO }}"
          have_label () { curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" "${API}/labels" | jq -r '.[].name' | grep -qx "$1"; }
          create_label () { curl -sS -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" "${API}/labels" -d "{\"name\":\"$1\",\"color\":\"a3f7bf\",\"description\":\"$2\"}"; }
          have_label "mirror:ready" || create_label "mirror:ready" "Upstream PR is ready-for-review"
          have_label "mirror:draft" || create_label "mirror:draft" "Upstream PR is draft"

      - name: Apply/remove labels based on upstream state
        if: github.event.action != 'closed'
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        run: |
          set -euo pipefail
          API="${{ env.GHES_BASE_URL }}/api/v3/repos/${{ env.GHES_OWNER }}/${{ env.GHES_REPO }}"
          PR_ID="${{ steps.ensure_pr.outputs.existing_pr }}"
          DRAFT_FLAG="${{ github.event.pull_request.draft }}"

          if [ -z "${PR_ID}" ]; then
            echo "No GHES PR ID to label; skipping."
            exit 0
          fi

          # Helper: add/remove label
          add_label () { curl -sS -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" "${API}/issues/${PR_ID}/labels" -d "{\"labels\":[\"$1\"]}" > /dev/null; }
          remove_label () { curl -sS -X DELETE -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" "${API}/issues/${PR_ID}/labels/$1" > /dev/null || true; }

          if [ "${DRAFT_FLAG}" = "true" ]; then
            echo "Upstream is DRAFT → set mirror:draft, remove mirror:ready"
            add_label "mirror:draft"
            remove_label "mirror:ready"
          else
            echo "Upstream is READY → set mirror:ready, remove mirror:draft"
            add_label "mirror:ready"
            remove_label "mirror:draft"
          fi

      - name: Close up GHES branches for closed upstream PRs
        if: github.event.action == 'closed'
        env:
          GHES_PAT:  ${{ secrets.GHES_PAT  }}
        run: |
          set -euo pipefail
          PR_NUM="${{ github.event.pull_request.number }}"
          BRANCH="fork-pr-${PR_NUM}"
          API="${GHES_BASE_URL}/api/v3/repos/${GHES_OWNER}/${GHES_REPO}"
          RESP="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                    "${API}/pulls?state=open&head=${GHES_OWNER}:${BRANCH}" -w "\n%{http_code}")"
          HTTP_CODE="$(printf '%s\n' "$RESP" | tail -n1)"
          JSON="$(printf '%s\n' "$RESP" | sed '$d')"
          if [ "${HTTP_CODE}" = "200" ]; then
            PR_ID="$(printf '%s' "$JSON" | jq -r 'if type=="array" and length>0 then .[0].number else empty end')"
            if [ -n "$PR_ID" ]; then
              echo "Closing GHES PR #$PR_ID"
              curl -sS -X PATCH \
                -H "Authorization: token ${GHES_PAT}" \
                -H "Accept: ${GH_ACCEPT}" \
                "${API}/pulls/${PR_ID}" \
                -d '{"state":"closed"}' > /dev/null || true
            fi
          else
            echo "Pulls query failed HTTP=${HTTP_CODE}; payload:"
            echo "$JSON"
          fi
          echo "Deleting branch ${BRANCH} on GHES (idempotent)"
          curl -sS -X DELETE \
            -H "Authorization: token ${GHES_PAT}" \
            -H "Accept: ${GH_ACCEPT}" \
            "${API}/git/refs/heads/${BRANCH}" > /dev/null || true
