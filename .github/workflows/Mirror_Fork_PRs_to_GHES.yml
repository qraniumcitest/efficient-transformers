name: Mirror Fork PRs to GHES

on:
  pull_request:
    types: [opened, ready_for_review, synchronize, reopened, closed]
    branches: ["main"]

# Per-PR concurrency avoids cross-PR contention
concurrency:
  group: fork-pr-mirror-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  mirror_or_close:
    runs-on: [self-hosted, linux, x64]
    env:
      GHES_BASE_URL: https://github.qualcomm.com
      GHES_OWNER: qranium
      GHES_REPO: efficient-transformers

      # External fork context (used by status/dispatch)
      FORK_OWNER: qraniumcitest
      FORK_REPO: efficient-transformers

      # REST Accept headers
      GH_ACCEPT: "application/vnd.github+json, application/vnd.github.shadow-cat-preview+json"

      # Team policy: always squash+merge on GHES
      GHES_MERGE_METHOD: squash

      # Internal workflow dispatch (optional gating before merge)
      TARGET_OWNER: qranium
      TARGET_REPO: efficient-transformers
      TARGET_REF: main
      WORKFLOW_FILE_NAME: post_feedback_to_gh_pr.yml

    steps:
      - name: Exit if running in internal repo
        if: github.repository == 'qranium/efficient-transformers'
        run: |
          echo "This workflow should not run in the internal repo. Exiting."
          exit 0

      - name: Debug event
        run: |
          echo "Event      : ${{ github.event_name }} / ${{ github.event.action }}"
          echo "PR #       : ${{ github.event.pull_request.number }}"
          echo "Draft?     : ${{ github.event.pull_request.draft }}"
          echo "Head ref   : ${{ github.event.pull_request.head.ref }}"
          echo "Head sha   : ${{ github.event.pull_request.head.sha }}"
          echo "Merged?    : ${{ github.event.pull_request.merged }}"

      - name: Preflight - verify GHES env and connectivity
        run: |
          set -Eeuo pipefail
          nslookup github.qualcomm.com || { echo "DNS lookup failed. Connect VPN then re-run"; exit 1; }
          curl -I --max-time 10 "https://github.qualcomm.com" || { echo "Cannot reach GHES over HTTPS. Connect VPN then re-run"; exit 1; }

      - name: Checkout PR head
        if: github.event.action != 'closed'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Configure git
        if: github.event.action != 'closed'
        run: |
          set -Eeuo pipefail
          git config user.email "pr-mirror@local"
          git config user.name  "pr-mirror"

      - name: Add GHES remote
        if: github.event.action != 'closed'
        env:
          GHES_USER: ${{ secrets.GHES_USER }}
          GHES_PAT:  ${{ secrets.GHES_PAT  }}
        run: |
          set -Eeuo pipefail
          git remote add ghes "${GHES_BASE_URL}/${GHES_OWNER}/${GHES_REPO}.git" || true
          git remote set-url ghes "https://${GHES_USER}:${GHES_PAT}@github.qualcomm.com/${GHES_OWNER}/${GHES_REPO}.git"
          git ls-remote ghes --heads

      - name: Push PR branch to GHES
        if: github.event.action != 'closed'
        id: push_branch
        run: |
          set -Eeuo pipefail
          PR_NUM="${{ github.event.pull_request.number }}"
          BRANCH="fork-pr-${PR_NUM}"
          git push ghes "HEAD:refs/heads/${BRANCH}" --force
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"

      # Canonical title: "[Fork PR #<N>] <upstream title>"
      - name: Ensure GHES PR title exists and is canonical
        if: github.event.action != 'closed'
        id: ensure_pr
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        shell: bash
        run: |
          set -Eeuo pipefail
          PR_NUM="${{ github.event.pull_request.number }}"
          TITLE="${{ github.event.pull_request.title }}"
          DRAFT_FLAG="${{ github.event.pull_request.draft }}"
          API="${{ env.GHES_BASE_URL }}/api/v3/repos/${{ env.GHES_OWNER }}/${{ env.GHES_REPO }}/pulls"
          BRANCH="${{ steps.push_branch.outputs.branch }}"
          CANON_TITLE="[Fork PR #${PR_NUM}] ${TITLE}"

          EXISTING="$(curl -s -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                      "${API}?state=open&head=${{ env.GHES_OWNER }}:${BRANCH}" | jq -r '.[0].number // empty')"

          if [[ "$DRAFT_FLAG" == "true" ]]; then DRAFT_JSON=true; else DRAFT_JSON=false; fi

          if [[ -n "$EXISTING" ]]; then
            echo "Updating GHES PR #${EXISTING} title to canonical form"
            curl -s -X PATCH \
              -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
              "${API}/${EXISTING}" \
              -d "$(jq -n --arg t "$CANON_TITLE" '{title:$t}')" >/dev/null
            echo "existing_pr=${EXISTING}" >> "$GITHUB_OUTPUT"
          else
            echo "Creating GHES PR (draft=${DRAFT_JSON}) with canonical title"
            RESP="$(curl -s -X POST \
              -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
              "${API}" \
              -d "$(jq -n \
                    --arg t "$CANON_TITLE" \
                    --arg h "${BRANCH}" \
                    --arg b "" \
                    --arg base "main" \
                    --argjson draft "$DRAFT_JSON" \
                    '{title:$t, head:$h, base:$base, body:$b, draft:$draft}')" )"
            CREATED_NUM="$(printf '%s' "$RESP" | jq -r '.number // empty')"
            echo "existing_pr=${CREATED_NUM}" >> "$GITHUB_OUTPUT"
          fi

      - name: Set commit status gate (qeff/ready)
        if: github.event.action != 'closed'
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        shell: bash
        run: |
          set -Eeuo pipefail
          API_BASE="${{ env.GHES_BASE_URL }}/api/v3"
          OWNER="${{ env.GHES_OWNER }}"
          REPO="${{ env.GHES_REPO }}"
          SHA="${{ github.event.pull_request.head.sha }}"
          if [[ "${{ github.event.pull_request.draft }}" == "true" ]]; then
            STATE="pending"; DESC="Upstream PR is Draft"
          else
            STATE="success"; DESC="Upstream PR Ready for CI"
          fi
          curl -sS -X POST \
            -H "Authorization: token ${GHES_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "${API_BASE}/repos/${OWNER}/${REPO}/statuses/${SHA}" \
            -d "$(jq -n \
                  --arg state "$STATE" \
                  --arg context "qeff/ready" \
                  --arg description "$DESC" \
                  '{state:$state, context:$context, description:$description}')"

      - name: Align GHES PR state to upstream (single endpoint)
        if: github.event.action != 'closed'
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        shell: bash
        run: |
          set -Eeuo pipefail
          API_BASE="${{ env.GHES_BASE_URL }}/api/v3/repos/${{ env.GHES_OWNER }}/${{ env.GHES_REPO }}"
          DRAFT_FLAG="${{ github.event.pull_request.draft }}"
          PR_ID="${{ steps.ensure_pr.outputs.existing_pr }}"
          if [[ -z "$PR_ID" ]]; then
            echo "No GHES PR number resolved; skipping state alignment."
            exit 0
          fi
          API_PR="${API_BASE}/pulls/${PR_ID}"
          if [[ "$DRAFT_FLAG" == "true" ]]; then
            curl -sS -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                 "${API_PR}/convert_to_draft" >/dev/null || true
          else
            curl -sS -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                 "${API_PR}/ready_for_review" >/dev/null || true
          fi

      - name: Trigger internal workflow via workflow_dispatch (only on Ready transition)
        if: github.event.action == 'ready_for_review' && github.event.pull_request.draft == false
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        shell: bash
        run: |
          set -Eeuo pipefail
          API_BASE="https://github.qualcomm.com/api/v3/repos/${TARGET_OWNER}/${TARGET_REPO}"
          WF_LIST="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: application/vnd.github+json" \
            "${API_BASE}/actions/workflows")"
          WF_ID="$(printf '%s' "${WF_LIST}" | jq -r --arg name "${WORKFLOW_FILE_NAME}" \
            '.workflows[] | select(.path | endswith($name)) | .id')"
          if [[ -z "$WF_ID" ]] || [[ "$WF_ID" == "null" ]]; then
            echo "âŒ Workflow '${WORKFLOW_FILE_NAME}' not found in ${TARGET_OWNER}/${TARGET_REPO}."
            echo "${WF_LIST}" | jq .
            exit 1
          fi
          EXT_PR="${{ github.event.pull_request.number }}"
          SHA="${{ github.event.pull_request.head.sha }}"
          INT_PR="${{ steps.ensure_pr.outputs.existing_pr }}"
          DISPATCH_URL="${API_BASE}/actions/workflows/${WF_ID}/dispatches"
          HTTP_CODE="$(curl -sS -o /tmp/dispatch.out -w "%{http_code}" \
            -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: application/vnd.github+json" \
            "${DISPATCH_URL}" \
            -d "$(jq -n \
                  --arg ref "${TARGET_REF}" \
                  --arg int_pr "${INT_PR}" \
                  --arg ext_pr "${EXT_PR}" \
                  --arg sha "${SHA}" \
                  '{ref: $ref, inputs: {pr_number: $int_pr, external_pr: $ext_pr, head_sha: $sha}}')" )"
          if [[ "$HTTP_CODE" != "204" ]]; then
            echo "âŒ workflow_dispatch failed (HTTP ${HTTP_CODE})"
            [ -f /tmp/dispatch.out ] && cat /tmp/dispatch.out || true
            exit 1
          fi
          echo "âœ… workflow_dispatch accepted (204)"

      # ðŸ”š Upstream closed â†’ propagate to GHES (wait, gate, merge, cleanup)
      - name: Propagate upstream closure to GHES (wait, gate, merge, cleanup)
        if: github.event.action == 'closed'
        env:
          GHES_PAT:  ${{ secrets.GHES_PAT  }}
        shell: bash
        run: |
          set -Eeuo pipefail
          PR_NUM="${{ github.event.pull_request.number }}"
          BRANCH="fork-pr-${PR_NUM}"
          API_BASE="${GHES_BASE_URL}/api/v3/repos/${GHES_OWNER}/${GHES_REPO}"
          MERGED="${{ github.event.pull_request.merged }}"
          echo "Upstream PR #${PR_NUM} closed; merged=${MERGED}; branch=${BRANCH}"

          # Guard: proceed only if upstream actually merged
          if [[ "$MERGED" != "true" ]]; then
            echo "Upstream PR closed without merge â†’ (policy) close mirrored GHES PR."
            RESP="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                      "${API_BASE}/pulls?state=all&head=${GHES_OWNER}:${BRANCH}")"
            PR_ID="$(printf '%s' "$RESP" | jq -r 'if type=="array" and length>0 then .[0].number else empty end')"
            if [[ -n "$PR_ID" ]]; then
              curl -sS -X PATCH -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                "${API_BASE}/pulls/${PR_ID}" -d '{"state":"closed"}' >/dev/null || true
            fi
            echo "Done (no merge)."
            exit 0
          fi

          # 1) Locate GHES PR for the mirrored branch
          RESP="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                    "${API_BASE}/pulls?state=all&head=${GHES_OWNER}:${BRANCH}" -w "\n%{http_code}" || echo)"
          HTTP_CODE="$(printf '%s\n' "$RESP" | tail -n1)"
          JSON="$(printf '%s\n' "$RESP" | sed '$d')"
          echo "Locate GHES PR HTTP=${HTTP_CODE}"
          PR_ID="$(printf '%s' "$JSON" | jq -r 'if type=="array" and length>0 then .[0].number else empty end')"
          if [[ -z "$PR_ID" ]]; then
            echo "No GHES PR found for ${BRANCH}."
            exit 0
          fi

          # 2) Get current head and call update-branch (best-effort)
          PR_FILE="$(mktemp)"
          CODE_PR="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                       -w "%{http_code}" -o "${PR_FILE}" "${API_BASE}/pulls/${PR_ID}")"
          OLD_SHA="$(jq -r '.head.sha // empty' "${PR_FILE}")"
          echo "Current GHES head sha=${OLD_SHA}"

          UPDATE_CODE="$(curl -sS -o /tmp/update.out -w "%{http_code}" -X PUT \
            -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
            "${API_BASE}/pulls/${PR_ID}/update-branch" -d '{}' || echo "000")"
          echo "Update-branch HTTP=${UPDATE_CODE}"
          [ -f /tmp/update.out ] && sed -n '1,120p' /tmp/update.out || true

          # 3) Poll for update completion (new head or mergeable_state: clean)
          NEW_SHA=""
          MERGEABLE_STATE=""
          MAX=40  # ~80s
          for i in $(seq 1 $MAX); do
            S_FILE="$(mktemp)"
            C="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
                    -w "%{http_code}" -o "${S_FILE}" "${API_BASE}/pulls/${PR_ID}")"
            if [[ "$C" -ge 200 && "$C" -lt 300 ]]; then
              NEW_SHA="$(jq -r '.head.sha // empty' "${S_FILE}")"
              MERGEABLE_STATE="$(jq -r '.mergeable_state // empty' "${S_FILE}")"
              echo "Poll #$i â†’ head=${NEW_SHA} mergeable_state=${MERGEABLE_STATE}"
              if [[ ( -n "$OLD_SHA" && "$NEW_SHA" != "$OLD_SHA" ) || "$MERGEABLE_STATE" == "clean" ]]; then
                break
              fi
            fi
            sleep 2
          done
          if [[ -z "$NEW_SHA" ]]; then NEW_SHA="${OLD_SHA}"; fi

          # 4) Post qeff/ready=success on NEW_SHA (satisfy hooks/protections)
          if [[ -n "$NEW_SHA" ]]; then
            echo "Posting qeff/ready=success on ${NEW_SHA}"
            curl -sS -X POST \
              -H "Authorization: token ${GHES_PAT}" -H "Accept: application/vnd.github+json" \
              "${GHES_BASE_URL}/api/v3/repos/${GHES_OWNER}/${GHES_REPO}/statuses/${NEW_SHA}" \
              -d "$(jq -n \
                    --arg state "success" \
                    --arg context "qeff/ready" \
                    --arg description "Upstream PR merged; GHES branch updated" \
                    '{state:$state, context:$context, description:$description}')" \
              >/dev/null || true
          fi

          # 5) (Optional) dispatch internal workflow to run checks on NEW_SHA, then gate
          WF_LIST="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: application/vnd.github+json" \
            "${API_BASE}/actions/workflows")"
          WF_ID="$(printf '%s' "${WF_LIST}" | jq -r --arg name "${WORKFLOW_FILE_NAME}" \
            '.workflows[] | select(.path | endswith($name)) | .id')"
          if [[ -n "$WF_ID" && "$WF_ID" != "null" ]]; then
            echo "Dispatching internal workflow id=${WF_ID} for PR=${PR_ID} sha=${NEW_SHA}"
            DISPATCH_URL="${API_BASE}/actions/workflows/${WF_ID}/dispatches"
            D_CODE="$(curl -sS -o /tmp/dispatch.out -w "%{http_code}" \
              -X POST -H "Authorization: token ${GHES_PAT}" -H "Accept: application/vnd.github+json" \
              "${DISPATCH_URL}" \
              -d "$(jq -n --arg ref "${TARGET_REF}" \
                    --arg int_pr "${PR_ID}" --arg ext_pr "${PR_NUM}" --arg sha "${NEW_SHA}" \
                    '{ref: $ref, inputs: {pr_number: $int_pr, external_pr: $ext_pr, head_sha: $sha}}')" || echo "000")"
            echo "workflow_dispatch HTTP=${D_CODE}"
            [ -f /tmp/dispatch.out ] && sed -n '1,200p' /tmp/dispatch.out || true
          else
            echo "Internal workflow '${WORKFLOW_FILE_NAME}' not found; skipping dispatch."
          fi

          # 6) Gate on statuses and check suites for NEW_SHA
          READY="no"
          OK_S=""; OK_C=""
          MAX_GATE=45
          for i in $(seq 1 $MAX_GATE); do
            API_STAT="${GHES_BASE_URL}/api/v3/repos/${GHES_OWNER}/${GHES_REPO}/commits/${NEW_SHA}/statuses"
            API_CHECKS="${GHES_BASE_URL}/api/v3/repos/${GHES_OWNER}/${GHES_REPO}/commits/${NEW_SHA}/check-suites"
            RESP_S="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" "$API_STAT" || true)"
            OK_S="$(printf '%s' "$RESP_S" | jq -r '[.[] | select(.context=="qeff/ready")] | first | .state // empty' || true)"
            RESP_C="$(curl -sS -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" "$API_CHECKS" || true)"
            OK_C="$(printf '%s' "$RESP_C" | jq -r '[.check_suites[] | select(.status=="completed")] | all(.conclusion=="success")')"
            echo "Gate poll #$i â†’ status=${OK_S:-none} checks=${OK_C:-none}"
            if [[ "$OK_S" == "success" && "$OK_C" == "true" ]]; then READY="yes"; break; fi
            sleep 2
          done
          echo "Gate result â†’ READY=${READY}"
          if [[ "$READY" != "yes" ]]; then
            echo "Checks not green; leaving GHES PR #${PR_ID} open for retry. (No branch delete)"
            exit 0
          fi

          # 7) Attempt merge (squash)
          MERGE_CODE="$(curl -sS -o /tmp/merge.out -w "%{http_code}" -X PUT \
            -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
            "${API_BASE}/pulls/${PR_ID}/merge" \
            -d "$(jq -n \
                  --arg m "${GHES_MERGE_METHOD}" \
                  --arg t "Mirror of upstream merge for fork PR #${PR_NUM}" \
                  '{merge_method:$m, commit_title:$t}')" || echo "000")"
          echo "GHES merge HTTP=${MERGE_CODE}"
          [ -f /tmp/merge.out ] && sed -n '1,200p' /tmp/merge.out || true

          if [[ "$MERGE_CODE" -lt 200 || "$MERGE_CODE" -ge 300 ]]; then
            echo "Merge failed; keeping GHES PR #${PR_ID} open and preserving branch for retry."
            exit 0
          fi

          # 8) Delete mirrored branch only after successful merge
          echo "Deleting branch ${BRANCH}"
          DEL_CODE="$(curl -sS -o /tmp/del.out -w "%{http_code}" \
            -X DELETE -H "Authorization: token ${GHES_PAT}" -H "Accept: ${GH_ACCEPT}" \
            "${API_BASE}/git/refs/heads/${BRANCH}")"
          echo "Branch delete HTTP=${DEL_CODE}"
          [ -f /tmp/del.out ] && sed -n '1,120p' /tmp/del.out || true
          if [[ "$DEL_CODE" != "204" && "$DEL_CODE" != "404" ]]; then
            echo "Branch delete did not return 204/404 â†’ check permissions/protections."
          fi
          echo "GHES mirror cleanup complete."
