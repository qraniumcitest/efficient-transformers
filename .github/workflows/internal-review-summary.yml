name: Internal Review Summary

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "External PR number"
        required: true
      orig_repo:
        description: "External repository (e.g. org/repo)"
        required: true
      orig_sha:
        description: "External PR head SHA"
        required: true

jobs:
  internal_review_summary:
    runs-on: self-hosted

    steps:
      - name: Show inputs
        run: |
          echo "Triggered internal review summary for PR #${{ github.event.inputs.pr_number }}"
          echo "Original repo: ${{ github.event.inputs.orig_repo }}"
          echo "Original SHA:  ${{ github.event.inputs.orig_sha }}"

      - name: Locate internal review JSON on NFS
        id: locate
        env:
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
        run: |
          set -euo pipefail

          BASE_DIR="/prj/bdcqranium/qranium-ci/qeff-comments"
          FILE_PATH="${BASE_DIR}/pr-${PR_NUMBER}.json"

          echo "Looking for internal review JSON: ${FILE_PATH}..."

          if [ -f "${FILE_PATH}" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "file_path=${FILE_PATH}" >> "$GITHUB_OUTPUT"
            echo "Found internal review JSON for PR #${PR_NUMBER}."
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "file_path=${FILE_PATH}" >> "$GITHUB_OUTPUT"
            echo "No internal review JSON found for PR #${PR_NUMBER}."
          fi

      - name: Analyze internal review JSON via helper script
        id: analyze
        if: steps.locate.outputs.found == 'true'
        env:
          FILE_PATH: ${{ steps.locate.outputs.file_path }}
        run: |
          set -euo pipefail

          PY_HELPER="/prj/bdcqranium/qranium-ci/qeff-comments/Json-Parser/internal_review_analyzer.py"

          if [ ! -x "$PY_HELPER" ]; then
            echo "ERROR: Helper script not found or not executable: $PY_HELPER"
            echo "worst_state=failure" >> "$GITHUB_OUTPUT"
            echo "worst_summary=Internal review helper script missing" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Using helper script: $PY_HELPER"
          python3 "$PY_HELPER" "$FILE_PATH"

      - name: Handle missing internal review JSON
        if: steps.locate.outputs.found != 'true'
        run: |
          echo "Internal review JSON file not found at: ${{ steps.locate.outputs.file_path }}"
          echo "This might mean the internal review hasn't completed or export hasn't run yet."

      - name: Post internal-review status on commit
        if: always()
        env:
          GH_TOKEN:          ${{ secrets.GITHUB_TOKEN }}
          ORIG_REPO:         ${{ github.event.inputs.orig_repo }}
          ORIG_SHA:          ${{ github.event.inputs.orig_sha }}
          ANALYZE_STATE:     ${{ steps.analyze.outputs.worst_state }}
          ANALYZE_SUMMARY:   ${{ steps.analyze.outputs.worst_summary }}
          JSON_FOUND:        ${{ steps.locate.outputs.found }}
          PR_NUM:            ${{ github.event.inputs.pr_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID:     ${{ github.run_id }}
        run: |
          set -euo pipefail

          if [ "$JSON_FOUND" != "true" ]; then
            STATE="failure"
            SUMMARY="Internal review JSON missing or not yet generated"
          else
            if [ -z "${ANALYZE_STATE:-}" ]; then
              STATE="failure"
              SUMMARY="Internal review analysis failed"
            else
              STATE="$ANALYZE_STATE"
              SUMMARY="$ANALYZE_SUMMARY"
            fi
          fi

          echo "Final state: $STATE"
          echo "Final summary: $SUMMARY"

          TARGET_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          echo "Details URL: $TARGET_URL"

          echo "Posting status to $ORIG_REPO @ $ORIG_SHA"
          curl -sS -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${ORIG_REPO}/statuses/${ORIG_SHA}" \
            -d "$(jq -n \
              --arg state "$STATE" \
              --arg context "internal-review/qgenie" \
              --arg description "$SUMMARY" \
              --arg target_url "$TARGET_URL" \
              '{
                state: $state,
                context: $context,
                description: $description,
                target_url: $target_url
              }')"
