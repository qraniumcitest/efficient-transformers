name: Internal Review Summary

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Original PR number"
        required: true
        type: string
      orig_repo:
        description: "Original repo (owner/repo)"
        required: true
        type: string
      orig_sha:
        description: "Original head SHA"
        required: true
        type: string

jobs:
  summarize-internal-review:
    runs-on: self-hosted

    steps:
      - name: ðŸ“¥ Input parameters (PR / repo / SHA)
        id: show-inputs
        run: |
          echo "PR number : ${{ inputs.pr_number }}"
          echo "Repo      : ${{ inputs.orig_repo }}"
          echo "Head SHA  : ${{ inputs.orig_sha }}"

      - name: ðŸ“‚ Locate internal-review JSON on NFS
        id: locate-json
        run: |
          set -euo pipefail
          NFS_BASE="/prj/bdcqranium/qranium-ci/qeff-comments"
          JSON_PATH="${NFS_BASE}/pr-${{ inputs.pr_number }}.json"

          echo "Expected JSON path: ${JSON_PATH}"

          if [ ! -f "${JSON_PATH}" ]; then
            echo "ERROR: JSON file not found at ${JSON_PATH}"
            exit 1
          fi

          echo "json_path=${JSON_PATH}" >> "$GITHUB_OUTPUT"

      - name: ðŸ‘€ Raw JSON preview (first 400 chars)
        id: preview-json
        run: |
          set -euo pipefail
          JSON_PATH="${{ steps.locate-json.outputs.json_path }}"
          echo "Reading JSON from: ${JSON_PATH}"
          echo "----- JSON preview (first 400 chars) -----"
          head -c 400 "${JSON_PATH}" || true
          echo
          echo "------------------------------------------"

      - name: ðŸ“Š Analyze review using Python helper on NFS
        id: analyze-review
        run: |
          set -euo pipefail

          JSON_PATH="${{ steps.locate-json.outputs.json_path }}"
          # ðŸ” Adjust this path to where your qgenie_print_summary.py actually lives on NFS
          PY_HELPER="/prj/bdcqranium/qranium-ci/qeff-comments/Json-Parser/internal_review_analyzer.py"

          echo "Using JSON: ${JSON_PATH}"
          echo "Using Python helper: ${PY_HELPER}"
          echo "Python version:"
          python3 --version || true
          echo

          # ---- Call the Python helper to print the rich human-readable summary ----
          echo "===== Python helper output ====="
          python3 "${PY_HELPER}" "${JSON_PATH}"
          echo "===== End of Python helper output ====="
          echo

          # ---- Also compute summary fields via jq for worst_severity + logging ----
          HIGHEST_SEV=$(jq -r '.summary.highest_severity // "None"' "${JSON_PATH}")
          TOTAL_FILES=$(jq -r '.summary.total_files // 0' "${JSON_PATH}")
          TOTAL_ISSUES=$(jq -r '.summary.total_issues // 0' "${JSON_PATH}")

          echo "===== Parsed Summary (from JSON) ====="
          echo "  total_files     = ${TOTAL_FILES}"
          echo "  total_issues    = ${TOTAL_ISSUES}"
          echo "  highestSeverity = ${HIGHEST_SEV}"
          echo

          echo "===== Decision (based on highestSeverity) ====="
          case "${HIGHEST_SEV}" in
            Critical|High)
              echo "Overall severity is ${HIGHEST_SEV} -> marking job as FAILED."
              echo "worst_severity=${HIGHEST_SEV}" >> "$GITHUB_OUTPUT"
              exit 1
              ;;
            Medium|Low|None|"")
              echo "Overall severity is ${HIGHEST_SEV} -> marking job as PASSED."
              echo "worst_severity=${HIGHEST_SEV}" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unknown severity '${HIGHEST_SEV}' -> treating as PASSED."
              echo "worst_severity=${HIGHEST_SEV}" >> "$GITHUB_OUTPUT"
              ;;
          esac

      # âœ… Post internal-review status on original commit (same as before)
      - name: âœ… Post internal-review status on original commit
        if: always()
        env:
          GH_TOKEN:       ${{ secrets.GITHUB_TOKEN }}
          ORIG_REPO:      ${{ inputs.orig_repo }}
          ORIG_SHA:       ${{ inputs.orig_sha }}
          WORST_SEVERITY: ${{ steps.analyze-review.outputs.worst_severity }}
          GITHUB_REPO:    ${{ github.repository }}
          GITHUB_RUN_ID:  ${{ github.run_id }}
        run: |
          set -euo pipefail

          # Map worst_severity to GitHub status state
          case "${WORST_SEVERITY}" in
            Critical|High)
              STATE="failure"
              ;;
            Medium|Low|None|"")
              STATE="success"
              ;;
            *)
              STATE="success"
              ;;
          esac

          SUMMARY="Internal review: worst severity=${WORST_SEVERITY}"

          TARGET_URL="https://github.com/${GITHUB_REPO}/actions/runs/${GITHUB_RUN_ID}"
          echo "Final state: ${STATE}"
          echo "Summary    : ${SUMMARY}"
          echo "Details URL: ${TARGET_URL}"
          echo "Posting status to ${ORIG_REPO} @ ${ORIG_SHA}"

          curl -sS -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${ORIG_REPO}/statuses/${ORIG_SHA}" \
            -d "$(jq -n \
              --arg state "$STATE" \
              --arg context "internal-review/qgenie" \
              --arg description "$SUMMARY" \
              --arg target_url "$TARGET_URL" \
              '{
                state: $state,
                context: $context,
                description: $description,
                target_url: $target_url
              }')"
