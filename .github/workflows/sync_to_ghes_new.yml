name: Sync to GHES
on:
  push:
    branches: [ "main" ]
    tags: ["*"]
  workflow_dispatch:
    
jobs:
  push_to_ghes:
    runs-on: self-hosted
    defaults:
      run:
        shell: bash
    env:
      GHES_BASE_URL: "https://github.qualcomm.com"
      GHES_OWNER: "qraniumtest"
      GHES_REPO: "efficient-transformers"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: 
          fetch-depth: 0 

      - name: Configure git
        run: |
          git config user.email "sync-bot@local"
          git config user.name "sync-bot"

      - name: Check GHES reachability
        run: |
          set -e
          curl -I --max-time 10 "https://github.qualcomm.com"

      - name: Add GHES remote
        env:
          GHES_USER: ${{ secrets.GHES_USER }}
          GHES_PAT: ${{ secrets.GHES_PAT }}
        run: |
          set -e
          #Recreate remote to be idempotent
          git remote add ghes "https://github.qualcomm.com/qraniumtest/efficient-transformers.git" || true
          git remote set-url ghes "https://${GHES_USER}:${GHES_PAT}@github.qualcomm.com/qraniumtest/efficient-transformers.git"
          git ls-remote ghes --heads
          
      - name: Push branch main to GHES
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git push ghes main:main --force-with-lease

      - name: Push tag to GHES
        if: github.ref_type == 'tag'
        env:
          GHES_PAT: ${{ secrets.GHES_PAT }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          git push ghes "refs/tags/${TAG}:refs/tags/${TAG}" --force
